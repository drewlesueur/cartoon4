<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">  
<head>
<style>
#play {
  width: 100%;
  background-color: #eeeeee;
  height: 20px;
  position: relative
}

.track {
  width: 100%;
  background-color: rgb(76,69,55);
  height: 20px;
  position: relative;
  border-bottom: 1px solid rgb(157,165,154);
}

.selected {
  background-color: rgb(176, 169, 155) !important;
}


#backdrop {
  background-color: white;
  height: 1000px;
  width: 1680px;
  position: absolute;
  left: 0;
  top: 0;
  
}

#stage {
width: 100%;
border: 1px solid black;
height: 200px;
position: relative;
}

.object {
   //resize: both;
   overflow: auto;
  
  
   position: absolute;
}

#needle {
  width : 5px;
  background-color: green;
  height: 20px;
  position: absolute;
}

#tracks {
  height: 370px;
  overflow: scroll;
}

.move {
  background-color: rgb(247,201,0);
  position: absolute;
  height: 20px;
}

.move-selected {
  border: 1px solid rgb(255,255,100);
  margin: -1px;
}

.move-used {
  -webkit-box-shadow: rgba(0, 0, 0, 1) 0px 0px 10px;
}

.object-selected {
  -webkit-box-shadow: rgba(0, 0, 0, 1) 0px 0px 10px;
}


.resizer {
  background-color: green;
  position: absolute;
  right: 0px;
  bottom: 0px;
  width: 5px;
  height: 5px;
  
}

@-webkit-keyframes bounce {
 0% {
   left: 0px;
   display: none;
 }
 
 49.9999% {
    opacity:0;
    left: 400px;
 }
 50% {
    
    left: 400px;
    display: none;
 }
 100%{
   left: 800px;
   display: none;
 }
}





#test {
  background-color: #778C88;
  position: absolute;
  width: 100px;
  height: 100px;
  -webkit-box-shadow: rgba(0, 0, 0, 1) 0px 0px 10px;
  -webkit-animation-name: bounce;
 -webkit-animation-duration: 1s;
 -webkit-animation-iteration-count: 10;
 -webkit-animation-timing-function: ease;
 /*-webkit-animation-direction: alternate;*/
 border-radius: 10px;
  
}



/*
@-webkit-keyframes kf_obj_0 {
  from {
  
  }
  4.169390866270236% {
    top: 47px;
    left: 24px;
    width: 78px;
    height: 106px;
  }
  8.923053301645794% {
    top: 40px;
    left: 575px;
    width: 78px;
    height: 106px;
  }
  
  to {
  
  }
  
}
#obj_0 {
  background-color: green !important;
  -webkit-animation-name: kf_obj_0;
-webkit-animation-duration: 30.040815353393555s;
-webkit-animation-iteration-count: 1;
}
*/



</style>
<script src="jquery.js"></script>
<script src="jquery.json.js"></script>
<script src="util.js"></script>
<script src="coffeescript.js"></script>
<script>
//{"1278100915669":[1.5940380096435547,1.6890380382537842,1.8050379753112793,1.8800380229949951,1.9745570421218872,2.068557024002075,2.2215569019317627,2.347076892852783,2.480077028274536,2.6855969429016113,2.891597032546997,3.007596969604492,3.2041149139404297,3.2671151161193848,3.385114908218384,3.7266340255737305,3.839154005050659,4.1361541748046875,4.263672828674316,4.485672950744629,4.616191864013672,5.031713008880615,5.149713039398193,5.629749774932861,5.9457502365112305,6.3212690353393555,6.497788906097412,6.590788841247559,6.676788806915283,6.879309177398682,7.0073089599609375,7.148828029632568,7.2068281173706055,7.329827785491943,7.532345771789551,8.2363862991333,8.579385757446289,8.664904594421387,8.741905212402344,8.877904891967773,8.95290470123291,9.056425094604492,9.192424774169922,9.278425216674805,9.349943161010742,9.45494270324707,9.609943389892578,9.796462059020996,9.915461540222168,10.133980751037598,10.263980865478516,10.775501251220703,11.223539352416992,11.343539237976074,11.436538696289062,11.627058029174805,11.743058204650879,11.935057640075684,12.063577651977539,12.24357795715332,12.37309741973877,12.553096771240234,12.694616317749023,12.982616424560547,13.155136108398438,13.477655410766602,13.576655387878418,14.531693458557129,14.664214134216309,14.769213676452637,14.84421443939209,14.958732604980469,15.10273265838623,15.199732780456543,15.290251731872559,15.443251609802246,15.57125186920166,15.943770408630371,17.1888484954834,17.433849334716797,17.575366973876953,17.79436683654785,17.94188690185547,18.121885299682617,18.289405822753906,18.48140525817871,18.617406845092773,19.549962997436523]}
var moves_meta = []

$(function(){
  custom = function() {}
  initialize = function() {}
  
  playing = false
  $(document.body).click(function(e){
      if (!$(e.target).is(".move, .track")) {
        //$('.move-selected').removeClass("move-selected")
        //$('.selected').removeClass("selected")
      }
  })
  
  
  /*
  var lastSheet = document.styleSheets[document.styleSheets.length - 1]
  lastSheet.insertRule("@-webkit-keyframes test2 { 0% { top: 0px; } 50.556% {left: 100px;} 100% {top: 100px;} }", lastSheet.cssRules.length);
 //$('#test')[0].style.webkitAnimationName = 'test2'
  $('#test').css({
      '-webkit-animation-name' : 'test2',
      '-webkit-animation-duration' : '0.5s',
      '-webkit-animation-iteration-count' : '10'
  })
  */
  

    
  
   function draggable_x(el, func) {
      $(el).mousedown(function(e){
          var obj = this;
          e.preventDefault()
          var parent_offset_left = $(obj).parent().offset().left
          var start_offset_left = e.pageX - $(obj).offset().left //- parent_offset_left
          function mousemove(e){
              var new_left = e.pageX - parent_offset_left - start_offset_left
              $(obj).css("left", (new_left) + "px")
              func && func(obj)
          }
          function mouseup(e){
             $(document.body).unbind("mousemove", mousemove)
          }
          $(document.body).bind("mousemove", mousemove)
          $(document.body).bind("mouseup", mouseup)
      })
   }
   
   
     function draggable(el, func) {
      $(el).mousedown(function(e){
          var obj = this;
          e.preventDefault()
          var parent_offset_left = $(obj).parent().offset().left
          var parent_offset_top = $(obj).parent().offset().top
          
          var start_offset_left = e.pageX - $(obj).offset().left //- parent_offset_left
          var start_offset_top = e.pageY - $(obj).offset().top //- parent_offset_top
          function mousemove(e){
              var new_left = e.pageX - parent_offset_left - start_offset_left
              var new_top = e.pageY - parent_offset_top - start_offset_top
              $(obj).css("left", (new_left) + "px")
              $(obj).css("top", (new_top) + "px")
              
              if (func) {
                func(obj)
              }
          }
          function mouseup(e){
             $(document.body).unbind("mousemove", mousemove)
          }
          $(document.body).bind("mousemove", mousemove)
          $(document.body).bind("mouseup", mouseup)
      })
  }
   
   function resizable(el, func) {
       var resizer = $('<div class="resizer"></div>')
       $(el).append(resizer)
       var obj = el;
       $(resizer).mousedown(function(e){
          e.preventDefault()
          e.stopPropagation()
           var parent_offset_left = $(obj).parent().offset().left
           var parent_offset_top = $(obj).parent().offset().top
           
           var start_offset_left = e.pageX - $(this).offset().left //+ $(this).offset().left //- parent_offset_left
           var start_offset_top = e.pageY - $(this).offset().top //+ $(this).offset().top
           
           var resizer_width = $(resizer).width();
           var resizer_height = $(resizer).height()
           var offset_left = $(obj).offset().left - parent_offset_left
           var offset_top = $(obj).offset().top - parent_offset_top
            
            function mousemove(e){
              $(obj).css("width", (e.pageX - parent_offset_left + resizer_width - start_offset_left) - offset_left + "px")
              $(obj).css("height", (e.pageY - parent_offset_top + resizer_height - start_offset_top) - offset_top + "px")
              func && func(obj)
            }
            function mouseup(e){
               $(document.body).unbind("mousemove", mousemove)
            }
            $(document.body).bind("mousemove", mousemove)
            $(document.body).bind("mouseup", mouseup)
           
       })
   }
   
      function resizable_x(el, func) {
       var resizer = $('<div class="resizer"></div>')
       $(el).append(resizer)
       var obj = el;
       $(resizer).mousedown(function(e){
          e.preventDefault()
          e.stopPropagation()
           var parent_offset_left = $(obj).parent().offset().left
           var parent_offset_top = $(obj).parent().offset().top
           
           var start_offset_left = e.pageX - $(this).offset().left //+ $(this).offset().left //- parent_offset_left
           var start_offset_top = e.pageY - $(this).offset().top //+ $(this).offset().top
           
           var resizer_width = $(resizer).width();
           var resizer_height = $(resizer).height()
           var offset_left = $(obj).offset().left - parent_offset_left
           var offset_top = $(obj).offset().top - parent_offset_top
            
            function mousemove(e){
              $(obj).css("width", (e.pageX - parent_offset_left + resizer_width - start_offset_left) - offset_left + "px")
              //$(obj).css("height", (e.pageY - parent_offset_top + resizer_height - start_offset_top) - offset_top + "px")
              func && func(obj)
            }
            function mouseup(e){
               $(document.body).unbind("mousemove", mousemove)
            }
            $(document.body).bind("mousemove", mousemove)
            $(document.body).bind("mouseup", mouseup)
           
       })
   }
   
   
   
   
  
  
  
  current_track = "";
  moves = {}
  var playing;
  var audio = $('#main-song')[0]
  var last_key = ""
  var object_count = 0;
  var move_count = 0;
  var needle_interval;
  objects = {}
  perform_simple = false;
  perform_simple_index = 0;
  perform_simple_info = []
  perform_simple_times = []
  
  perform_custom = false;
  perform_custom_index = 0;
  perform_custom_info = []
  perform_custom_times = []
  
  
  var relevant_css = [
    'top',
    'left',
    'width',
    'height',
    'opacity',
    'background-color',
    '-webkit-transform',
    'border-radius',
    'background-image',
    //'rotation-point',
    '-webkit-transform',
    '-webkit-transform-origin',
    'color',
    'font-size',
    'font-weight',
    'font-family',
    
    
    
  ]
  
  for (var i in relevant_css) {
      var attr = relevant_css[i]
      $('#css_controls').append(attr + '<input type="text" placeholder="'+attr+'" data-css="'+attr+'">')
  }
  
  $('#css_controls').keyup(function(e) {
      if ($(e.target).is("input")) {
            $('.object-selected').css($(e.target).attr('data-css'), $(e.target).val())
            save_state($('.object-selected'))
      }
  })
  
   
  $(document).keydown(function(e){
      if (e.keyCode == 8) {
          $('.move-selected')
      }
      //if ($(e.target).is("input")) return;
      if (playing == false) return;
      
      e.preventDefault()
      if (e.keyCode == last_key) return;
      last_key = e.keyCode
      //last key deal because keydown is fired as you hold the key down
      
      
      if (e.keyCode == 32) {
        moves[current_track].push(audio.currentTime)
        used_track = current_track
      } else {
        specified_track = String.fromCharCode(e.keyCode).toLowerCase()
        moves[specified_track].push(audio.currentTime)
        used_track = specified_track
      }
      
      if (window.custom) {
         custom(used_track, audio.currentTime, audio.currentTime, "", true, "")
      } 
      
      
  }).keyup(function(e){
      
      //if ($(e.target).is("input")) return;
      if (playing == false) return;
      
      
      last_key = "";
      
      if (e.keyCode == 32) {
        moves[current_track].push(audio.currentTime)
        used_track = current_track
      } else {
        specified_track = String.fromCharCode(e.keyCode).toLowerCase()
        moves[specified_track].push(audio.currentTime)
        used_track = specified_track
      }
      
      
      
      
      var these_moves = moves[used_track]
      var last_move_time = _s(these_moves, -1)[0]
      var second_last_move_time = _s(these_moves, -2,1)[0]
      //var track = $('#' + current_track)
      put_move(last_move_time, second_last_move_time , used_track, these_moves.length - 1)
      
      if (window.custom) {
         custom(used_track, audio.currentTime, audio.currentTime, "", false, "")
      } 
      
  })
  
  function put_move(last_move_time, second_last_move_time, id, index, meta) {
       var track = $('#' + id)
       var duration_width_ratio =   track.width() / audio.duration
      
      
      var left = second_last_move_time * duration_width_ratio;
      var width = (last_move_time - second_last_move_time) * duration_width_ratio
      
      if (width < 1) {
        width = 1;
      }
      
      var move = $('<div id="move_'+move_count+'" class="move" style="left: '+left+'px; width:'+width+'px;" data-start="'+second_last_move_time+'" data-end="'+last_move_time+'"><div class="meta">'+(meta || "")+'</div></div>')
      track.append(move)
      
      function update_move(obj) {
          var ratio = audio.duration / $(track).width()
          var new_left = $(obj).position().left
          var new_second_last = new_left * ratio
          var new_last = (new_left + $(obj).width()) * ratio
          moves[id][index] = new_last
          moves[id][index - 1] = new_second_last
          
          $(obj).attr('data-start', new_second_last)
          $(obj).attr('data-end', new_last)
      }
      resizable_x(move, update_move)
      draggable_x(move, update_move)
      move_count++;
  }
  
  

  function setPlayHead() {
     
     var duration = audio.duration
     var currentTime = audio.currentTime
     
     var width = $("#play").width()
     var pos = currentTime / duration * width
     $('#needle').css("left", pos + "px")
     $('#time').text(audio.currentTime)
     if (perform_simple == true) {
				while (audio.currentTime >= perform_simple_times[perform_simple_index]) {
						var todos = perform_simple_info[perform_simple_index]
						for (var i in todos) {
								var todo = todos[i]
								$('#' + todo.obj).css(todo.css)
						}
						//custom && custom(audio.currentTime, perform_simple_times[perform_simple_index], perform_simple_index)
						perform_simple_index++
				}
		 }
		 if (perform_custom == true) {
        while (audio.currentTime >= perform_custom_times[perform_custom_index]) {
						var meta = perform_custom_info[perform_custom_index]
						custom(meta[1], audio.currentTime, perform_custom_times[perform_custom_index], meta[0], meta[2], perform_custom_index )
						perform_custom_index++
				}
		 }
  }
  
      
      //var audio = $("<audio id='main-song'></audio>")
      $(audio).bind('canplaythrough', function(){
          //this.play()
          this.volume = 0.25
      }).bind('play', function(){
          playing = true;
          
          audio.playbackRate = $('#rate').val() - 0 || 1
          needle_interval = setInterval(setPlayHead, 10)
      }).bind("pause", function(){
          playing = false;
          //clearTimeout(needle_interval)
      })
      
      
      
      $('#tracks').click(function(e) {
          
          
          if ($(e.target).is(".move")) {
             
             if (e.ctrlKey) {
               
               var meta = prompt("info?")
               $(e.target).find(".meta").text(meta)
               var current_move = $(e.target).attr("id")
               current_move = _s(current_move, "move_".length)
               current_move = current_move * 2
               
               moves_meta[current_track][current_move] = meta
               
               return
             }
             
             $('.move').removeClass("move-selected");
             
             $(e.target).addClass("move-selected");
             
             var on_what = $(e.target).attr('data-on')
             if (on_what != "start") {
                audio.currentTime = $(e.target).attr('data-start')
                $(e.target).attr('data-on', 'start')
                
                
                
             } else {
                audio.currentTime = $(e.target).attr('data-end')
                $(e.target).attr('data-on', 'end')
             }
             
             //applying the objects css at that time
             for (var i in objects) {
                var my_moves = objects[i]
                var data_on_abbr = $(e.target).attr('data-on') == "start" ? "s" : "e"
                var my_css = my_moves[e.target.id + "#" + data_on_abbr]
                $('#' + i).css(my_css || {})
                
                
             }
             
          } 
          
          if (!$(e.target).is(".track")) return;
          
          
          if (e.ctrlKey) {
            var meta = prompt("name?")
            
          }
          $('.track').removeClass('selected')
          $(e.target).addClass('selected')
          current_track = $(e.target).attr("id")
          
          
         
      })
      
      var track_count = -1;
      
      function add_track(id){
          
          track_count++;
          if (track_count == 0) {
            var id = "a";
          } else {
            var id = id || prompt("track name");
          }
          
          //var id = track_count;
          //var id = (new Date()).getTime()
          $('#tracks').append('<div class="track" id="'+id+'"><div style="position: absolute;">' + id + "<\/div><\/div>")
          current_track = id;
          moves[id] = []
          moves_meta[id] = []
          $('.track').removeClass("selected")
          $('#' + id).addClass('selected')
          
          
          return false
      }
      
      $('#add_track').click(function(e) {
          add_track()
      })
      
   $('#zoom').change(function(){
      var base = 500;
      var zoom = $(this).val()
      var width = zoom * base
      
      $('#play').css('width', width + "px")
      var selected_id = $('.selected').attr('id')
      redraw_tracks(width, selected_id)
   })
   
   
   $('#play').click(function(e){
      var left = e.pageX - $(this).offset().left 
      audio.currentTime = left * (audio.duration / $(this).width())
   })
   
   
  function get_relevant_css(obj) {
      var ret = {}
      //todo only save the css that is changed or has an actual value;
      for (var i in relevant_css) {
          var attr = relevant_css[i]
          ret[attr] = $(obj).css(attr)
      }
      return ret
      
      
  }
  
  
    function save_state(obj) {
    
          $(obj).each(function(){
              var id = $(this).attr('id')
              //switching from current time to go based off selected move
              //objects[id][audio.currentTime] = get_relevant_css(obj)
              
              var selected_move = $('.move-selected')
              if (selected_move.length == 0) {
                return;
              }
              var selected_move_id = selected_move.attr('id')
              var selected_move_on = selected_move.attr('data-on') == "end" ? "e" : "s"
              objects[id][selected_move_id + "#" + selected_move_on] = get_relevant_css(this)
          })
    }
   
   function add_object(e){
      e && e.preventDefault()
      var id = 'obj_'+object_count
      $('#stage').append('<div id="'+id+'" class="object"><div class="inner">har</div></div>');
      
      if (!(id in objects)) objects[id] = {};
      

      draggable('#' + id, save_state)
      
      resizable('#' + id, save_state)
      
      object_count++
      return $('#' + id);
   }
   
   
   
   $('#add_object').click(add_object)
   
   $('#stage').dblclick(function(e){
      e.preventDefault()
      
      if ($(e.target).is('.object')) {
          $(e.target).find(".inner").remove()
          $(e.target).append("<div class='inner'>" + prompt("text") + "</div>")
      } else if ($(e.target).is('.object div')) {
          var obj = $(e.target).parents('.object')
          $(obj).find(":not(.resizer)").remove()
          $(obj).append("<div class='inner'>" + prompt("text") + "</div>")
      }
   })
   
   $('#stage').click(function(e){
      $('.object-selected').removeClass('object-selected')
      if ($(e.target).is(".object") || $(e.target).is(".object div")) {
         
         var obj;
         if ($(e.target).is(".object")) {
           $(e.target).addClass("object-selected");
           obj = e.target
         } else {
            obj = $(e.target).parents('.object')[0]
            $(obj).addClass("object-selected");
         }
         
         for (var i in relevant_css) {
            var attr = relevant_css[i]
            var css_val = $(obj).css(attr)
            $("[data-css='"+attr+"']").val(css_val)
         }
         
         $('.move-used').removeClass('move-used')
         var obj_moves = objects[obj.id];
         for (var move_id in obj_moves) {
            move_id = _s(move_id, 0, -2); //taking off the #s
            $('#' + move_id).addClass('move-used')
         }
      } 
   })
   
   
   function redraw_tracks(width, selected_id) {
      
      move_count = 0;
      $('.track').remove();
      
      for (var i in moves) {
          var track = $('<div class="track" style="width: '+width+'px;" id="'+i+'">' + '<div style="position: absolute;">' + i + "<\/div><\/div>")
          var these_moves = moves[i]
          $('#tracks').append(track);
          for (var move_index = 0; move_index < these_moves.length; move_index+=2) {
              
              var meta = moves_meta[i] && moves_meta[i][move_index]
              put_move(these_moves[move_index+1], these_moves[move_index], i, move_index + 1, meta);
          }
          
          $('#' + selected_id).addClass('selected')
      }
      
      current_track = i
      $('#' + i).addClass('selected')
      
   }
   
   $('#rate').click(function(){
      audio.playbackRate = $(this).val() - 0 || 1
   })
   
   $('#save').click(function(e){
      e.preventDefault();
      
      var inners = {}
      for (var i in objects) {
         inners[i] = $('#' + i).find('.inner').html()
      }
      $('#saved').val(JSON.stringify({moves: moves, moves_meta: moves_meta, objects: objects, inners: inners, "custom": $('#custom').val()}))
   })
   
   $('#load').click(function(e){
      e.preventDefault()
      current_track = "";
      var saved = JSON.parse( $('#saved').val())
      
      moves = saved.moves
      objects = saved.objects
      moves_meta = saved.moves_meta
      object_count = 0;
      for (var obj in objects) {
          //todo: this depends on iterating thru objects in order .chrome??
          add_object();
      }
      redraw_tracks()
      last_key = ""
      
      inners = saved.inners
      
      for (var i in inners) {
					$('#' + i).find('.inner').html(inners[i]) 
      }
      
      $('#custom').val(saved.custom)
      
      
   })
   
   
   
   
   function generate_css(e){
      e && e.preventDefault()
      var css = []
      for (var i in objects) {
          css.push("@-webkit-keyframes kf_" + i + ' {');
          var moves_list = objects[i]
          
          //from
          //css.push("  0% {}")
          var lowest = 100;
          var highest = 0;
          
          for (var move in moves_list) {
              var move_id = _s(move,0,-2)
              var data_on = _s(move,-1) == "e" ? "end" : "start"
              
              
              var time = $('#' + move_id).attr('data-' + data_on);
              
              var percent = (time / audio.duration * 100)
              
              if (percent < lowest) {
                 lowest = percent
                 lowest_rules = moves_list[move];
              }
              
              if (percent > highest) {
                 highest = percent
                 highest_rules = moves_list[move];
              }
              
              percent = percent + "%"
              percent = percent + "%"
              
              css.push("  " + percent + " {")
              css_rules = moves_list[move];
              for (var css_rule in css_rules) {
                css.push("    " + css_rule + ": " + css_rules[css_rule] + ";");
              }
              css.push("  }")
          }
          
          
          css.push("  0% {")
              for (var css_rule in lowest_rules) {
                css.push("    " + css_rule + ": " + lowest_rules[css_rule] + ";");
              }
          css.push("  }");
          
          css.push("  100% {")
              for (var css_rule in highest_rules) {
                css.push("    " + css_rule + ": " + highest_rules[css_rule] + ";");
              }
          css.push("  }");
         
          
          css.push('}')
          
          css.push("#" + i + " {")
            css.push("  -webkit-animation-name: kf_"+i+";")
            css.push("-webkit-animation-duration: " + audio.duration + "s;") 
            css.push("-webkit-animation-iteration-count: 1;")
            css.push("-webkit-animation-timing-function: linear;")
          css.push("}") 
          
      }
      generated_css = css.join('\n');
      console.log(generated_css)
      
   }
   
   $('#generate_css').click(generate_css)
   
   
   $('#perform').click(function(){
      $('#stop').click()
      $('.perform_style').remove()
      generate_css();
     var style = $("<st"+"yle class='perform_style'>" + generated_css + "<"+"/s"+"tyle>")
     audio.currentTime = 0;
     
     setTimeout(function(){
        audio.play()
        $(document.body).append(style)
     
     }, 500)
     
     
     //setTimeout(function(){
     //   audio.pause(); 
     //   audio.currentTime = 0
        //function onplay(e){
        //  $(document.body).append(style)
        //  $(this).unbind('play', onplay)
        //}
        //$(audio).bind('play', onplay)
     //   audio.play()
        
     //}, 200)
     
     
     
     
     
     
   })
   
   $('#stop_performance').click(function(){
      
      
      $('.perform_style').remove()
      audio.pause()
      audio.currentTime = 0;
      perform_simple = false;
      perform_simple_index = false;
      perform_simple_info = []
      perform_simple_times = []
      
      perform_custom = false;
      perform_custom_index = false;
      perform_custom_info = []
      perform_custom_times = []
      
      $("#backdrop").remove();
      
      return false;
   })
   
   $('#perform_simple').click(function(){
			$('#stop').click()
			audio.currentTime = 0;
			setTimeout(function(){audio.play()}, 1000);
			var time_objs = {}
			//this might be faster if you kept track of which object that move deals with
			$('.move').each(function(){
					var time_start = $(this).attr('data-start')
					var time_end = $(this).attr('data-end')
					var move_id = this.id
					
					time_objs[time_start] = []
					time_objs[time_end] = [];
					
					for (var obj_id in objects) {
							var my_moves = objects[obj_id];
							if (my_moves[move_id + "#s"]) {
									time_objs[time_start].push({obj: obj_id, css: my_moves[move_id + "#s"]})
							}
							if (my_moves[move_id + "#e"]) {
									time_objs[time_end].push({obj: obj_id, css: my_moves[move_id + "#e"]})
							}
					}
					
					
			})
			
			perform_simple_info = []
			perform_simple_times = []
			
			
			//todo: might not work in future versions. the sortobject dealio. maybe bcom
			time_objs = sortObject_number(time_objs);
			
					perform_simple_times = time_objs[0]
					perform_simple_info = time_objs[1]
			
			
			perform_simple_index = 0;
			perform_simple = true;
   })
   
   
   
  $("#play_custom").click(function(){
    if ( window.initialize ) {
           $("body").append('<div id="backdrop"><\/div>') 
            $("#backdrop").click(function(){
              $('#stop_performance').click();
              
            })
            var raw = $('#custom').val() + "\nreturn custom: custom, initialize: initialize"
            raw = CoffeeScript.compile(raw)
            raw = eval(raw)
            custom = raw.custom
            initialize = raw.initialize
            initialize()
            
            audio.currentTime = 0;
			setTimeout(function(){audio.play()}, 1000);
    }
  
  })
  $('#perform_custom').click(function(){
			$('#stop').click()
			
			$("body").append('<div id="backdrop"><\/div>') 
			$("#backdrop").click(function(){
        $('#stop_performance').click();
        
			})
			
			perform_custom_info = []
			perform_custom_times = []
			
			//store combine time and other information and then sort by key then extract the needed information
			
			time_obj = {}
			for (var i in moves) {
        var track = moves[i];
        var track_meta = moves_meta[i]
        for (var j = 0; j < track.length; j++) {
          var move = track[j]
          var move_meta = track_meta && track_meta[j] || null
          time_obj[move] = [move_meta, i, j  % 2 == 0] //need to store if its even or odd
          
          //perform_custom_times.push(move)
          //perform_custom_info.push([move_meta,i])
        }
			}
			
			keys_vals = sortObject_number(time_obj)
			
			perform_custom_times = keys_vals[0];
			perform_custom_info = keys_vals[1];
			
			
			perform_custom_index = 0;
			perform_custom = true;
			var raw = $('#custom').val() + "\nreturn custom: custom, initialize: initialize"
			
			raw = CoffeeScript.compile(raw)
			raw = eval(raw)
			custom = raw.custom
			initialize = raw.initialize
			
			initialize()
			
			audio.currentTime = 0;
			setTimeout(function(){audio.play()}, 1000);
   })
   
   
   $('#unbind_move').click(function(){
      var obj = $('.object-selected')[0]
      
      var obj_moves = objects[obj.id]
      var move = $('.move-selected')[0]
      var suffix = $(move).attr('data-on') == "start" ? "#s" : "#e"
      delete obj_moves[move.id + suffix]
   })
   
   
   $('#clone_object').click(function(e) {
      var obj = $('.object-selected')[0];
      var css = get_relevant_css(obj);
      var obj = add_object();
      
      $(obj).css(css)
      return false;
   })
   
   $('#delete_object').click(function(e) {
      var obj = $('.object-selected')[0];
      delete objects[obj.id]
      $(obj).remove()
      return false;
   })
   
   /*
   $('#delete_move').click(function(e) {
      var obj = $('.move-selected')[0];
      delete moves[obj.id]
      $(obj).remove()
      return false;
   })*/
   
   
   
   
   function sortObject_number(o) {
    var sorted = {},
    key, a = [];

    for (key in o) {
        if (o.hasOwnProperty(key)) {
                a.push(key - 0);
        }
    }

    a.sort(function(a,b){return a-b});
    
    b = []
    
    for (var key in a) {
        b.push(o[a[key]])
    }
    
    return [a,b] //returns [array of keys and array of values]
    
	 }

   
   add_track("a")
   add_track("s")
   add_track("d")
   add_track("f")
   add_track("g")
   add_track("h")
   add_track("j")
   add_track("k")
   add_track("l")

  /*
  var canvas = $('#canvas')[0]
  var ctx = canvas.getContext("2d")
  ctx.fillStyle = "#ff1100";
  //ctx.fillRect(0,0,30,30)
  
  var img = new Image()
  img.onload = function(){
      ctx.drawImage(img,0,0)
  }
  img.src = "test.svg"
  */
  
  
  
  


  
  
})
</script>
</head>

<body>
<a href="#" id="add_object">Add object</a>
<a href="#" id="perform">Perform!</a>
<a href="#" id="perform_simple">Perform! simple</a>
<a href="#" id="perform_custom" style="font-weight: bold;">Perform! custom</a>
<a href="#" id="play_custom" style="font-weight: bold;">play custom</a>
<a href="#" id="stop_performance">Stop</a>
<a href="#" id="unbind_move">Unbind Move</a>
<a href="#" id="clone_object">Clone object</a>
<a href="#" id="delete_object">delete object</a>



  <div id="stage">
  <!--<div id="test">yo</div>-->
  </div>

<div id="css_controls">

</div>

<audio  id="main-song" controls=true src="audio/first.m4a"></audio>


<div id="time"></div>

<div id="tracks">
<div id="play">
<div id="needle"></div>
</div>
</div>
<a href="#"id="add_track">Add track</a><br />

<br />
Zoom<input type="text" id="zoom" /><br>
<input type="text" value="1" id="rate" /><br>
<a href="#" id="save">save</a> <br>
<textarea id="saved"></textarea><br>
<a href="#" id="load">load</a> <br>
<br />


<textarea rows = "20" cols="100" id="custom">
img = $('<img src="toon2.bmp">')
img.attr "src", "toon1.bmp"

b = ""
initialize = () ->
  
  #add dom to $("#backdrop")
  b = $("#backdrop")
  b.append(img)
  console.log()
  
custom = (track, realtime, time, meta, onstart, index) ->
  #manipulate dom based of params
  console.log track, onstart
  if track is "main" and onstart
    img.attr "src", "toon2.bmp"  
  else if track is "main" and not onstart
    img.attr "src", "toon1.bmp"
   





</textarea>



</body>


</html>


